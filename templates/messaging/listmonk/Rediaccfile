#!/bin/bash

# === Renet Compose Support ===
_use_renet() {
  [[ -n "$REPOSITORY_NETWORK_ID" ]] && command -v renet &>/dev/null
}
_compose() {
  if _use_renet; then
    renet compose --network-id "$REPOSITORY_NETWORK_ID" -- "$@"
  else
    docker compose "$@"
  fi
}

# Listmonk Newsletter Manager Lifecycle Functions

prep() {
  echo "Pulling Listmonk images..."
  docker pull listmonk/listmonk:latest
  local exit_code=$?
  if [ $exit_code -ne 0 ]; then
    echo "Failed to pull Listmonk image"
    return $exit_code
  fi

  docker pull postgres:17-alpine
  exit_code=$?
  if [ $exit_code -ne 0 ]; then
    echo "Failed to pull PostgreSQL image"
    return $exit_code
  fi

  echo "Creating data directories..."
  mkdir -p uploads postgres-data
  return $?
}

up() {
  echo "Starting Listmonk Newsletter Manager..."
  echo ""

  _compose up -d
  local exit_code=$?
  if [ $exit_code -ne 0 ]; then
    echo "Failed to start Listmonk"
    return $exit_code
  fi

  echo ""
  echo "Listmonk started successfully!"
  echo ""
  echo "⏳ Please wait ~30 seconds for initialization..."
  echo ""
  echo "Access the web interface:"
  echo "  1. Run: docker compose ps"
  echo "  2. Find the mapped port for ${LISTMONK_PORT:-9000}/tcp"
  echo "  3. Open: http://localhost:<mapped-port>/admin"
  echo ""
  echo "First-time setup:"
  echo "  • You will be prompted to create an admin account"
  echo "  • Choose a strong username and password"
  echo "  • This is a one-time setup on first visit"
  echo ""
  echo "⚠️  IMPORTANT - SMTP Configuration Required:"
  echo "  • Listmonk CANNOT send emails without SMTP configuration!"
  echo "  • After login, go to: Settings → SMTP"
  echo "  • Configure your SMTP server (see .env for provider examples)"
  echo "  • Test the connection before creating campaigns"
  echo ""
  echo "⚠️  SECURITY NOTES:"
  echo "  • Change admin password after first login!"
  echo "  • Admin credentials work only on first installation"
  echo "  • Use Settings → Users to manage additional users"
  echo ""
  echo "Check logs with: docker compose logs -f listmonk"
  echo "Official docs: https://listmonk.app/docs/"
  echo ""

  return 0
}

down() {
  echo "Stopping Listmonk and cleaning up..."
  _compose down -v
  return $?
}
