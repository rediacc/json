#!/bin/bash

# Plausible Community Edition Lifecycle Functions

prep() {
  echo "Pulling Plausible images..."
  docker pull ghcr.io/plausible/community-edition:v2.1.4
  local exit_code=$?
  if [ $exit_code -ne 0 ]; then
    echo "Failed to pull Plausible image"
    return $exit_code
  fi

  docker pull postgres:16-alpine
  exit_code=$?
  if [ $exit_code -ne 0 ]; then
    echo "Failed to pull PostgreSQL image"
    return $exit_code
  fi

  docker pull clickhouse/clickhouse-server:24.3.3.102-alpine
  exit_code=$?
  if [ $exit_code -ne 0 ]; then
    echo "Failed to pull ClickHouse image"
    return $exit_code
  fi

  echo "Creating data directories..."
  mkdir -p postgres-data clickhouse-data clickhouse-logs
  return $?
}

up() {
  echo "Starting Plausible Community Edition..."

  # Auto-generate SECRET_KEY_BASE on first run
  local secret_file="./plausible-secret.txt"

  if [ ! -f "$secret_file" ]; then
    echo "First run detected - generating SECRET_KEY_BASE..."
    echo ""

    # Generate 64-byte secret key
    local secret_key=$(openssl rand -base64 48)

    # Store secret key
    echo "SECRET_KEY_BASE=${secret_key}" > "$secret_file"
    chmod 600 "$secret_file"

    # Export for docker compose
    export SECRET_KEY_BASE="$secret_key"

    echo "‚úÖ Secret key generated and saved!"
    echo ""
    echo "üìÅ Key file: ${secret_file}"
    echo ""
    echo "‚ö†Ô∏è  IMPORTANT: Keep this file secure - required for data encryption!"
    echo ""
  else
    echo "Loading existing SECRET_KEY_BASE..."
    source "$secret_file"
    export SECRET_KEY_BASE
    echo ""
  fi

  docker compose up -d
  local exit_code=$?
  if [ $exit_code -ne 0 ]; then
    echo "Failed to start Plausible"
    return $exit_code
  fi

  echo ""
  echo "Plausible started successfully!"
  echo ""
  echo "‚è≥ Please wait ~60 seconds for initialization (database creation and migrations)..."
  echo ""
  echo "Access the web interface:"
  echo "  1. Run: docker compose ps"
  echo "  2. Find the mapped port for ${HTTP_PORT:-8000}/tcp"
  echo "  3. Open: http://localhost:<mapped-port>"
  echo ""
  echo "First-time setup:"
  echo "  ‚Ä¢ Create your admin account on first visit"
  echo "  ‚Ä¢ Registration mode: ${DISABLE_REGISTRATION:-invite_only}"
  echo "  ‚Ä¢ BASE_URL: ${BASE_URL:-http://localhost:8000}"
  echo ""
  echo "‚ö†Ô∏è  PRODUCTION NOTES:"
  echo "  ‚Ä¢ Change BASE_URL in .env to your actual domain"
  echo "  ‚Ä¢ Configure SMTP for email invites (see .env for options)"
  echo "  ‚Ä¢ Review registration settings"
  echo ""
  echo "Check logs with: docker compose logs -f plausible"
  echo "Official docs: https://plausible.io/docs/self-hosting"
  echo ""

  return 0
}

down() {
  echo "Stopping Plausible and cleaning up..."
  docker compose down -v
  return $?
}
