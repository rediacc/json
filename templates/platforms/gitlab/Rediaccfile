#!/bin/bash

# === Renet Compose Support ===
_use_renet() {
  [[ -n "$REPOSITORY_NETWORK_ID" ]] && command -v renet &>/dev/null
}
_compose() {
  if _use_renet; then
    renet compose --network-id "$REPOSITORY_NETWORK_ID" -- "$@"
  else
    docker compose "$@"
  fi
}

prep() {
    echo "Pulling GitLab CE image..."
    docker pull gitlab/gitlab-ce:latest

    echo "Creating directories..."
    mkdir -p ./config
    mkdir -p ./logs
    mkdir -p ./data
    chmod -R 755 ./config ./logs ./data

    echo "Note: GitLab requires significant resources (4GB+ RAM recommended)"

    return $?
}

up() {
    if [ -f .env ]; then
        source .env
    fi

    echo "Starting GitLab CE..."
    _compose up -d

    echo ""
    echo "GitLab is starting... This may take several minutes on first run."
    echo "You can monitor the startup with: docker logs -f ${CONTAINER_NAME}"
    echo ""
    echo "GitLab will be available at:"
    echo "  HTTP: http://localhost:${GITLAB_HTTP_PORT}"
    echo "  HTTPS: https://localhost:${GITLAB_HTTPS_PORT}"
    echo "  SSH: ssh://git@localhost:${GITLAB_SSH_PORT}"
    echo ""
    echo "Initial root password will be in: ./config/initial_root_password"
    echo "This file will be automatically deleted after 24 hours."

    return $?
}

down() {
    if [ -f .env ]; then
        source .env
    fi

    echo "Stopping GitLab CE..."
    _compose down -v
    return $?
}
